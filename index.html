<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Gamedev Canvas Workshop</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      canvas {
        background: #eee;
        display: block;
        margin: 0 auto;
      }
    </style>
    <script src="./player.js"></script>
  </head>
  <body>
    <div style="width: 480px; height: 320px;">
        <canvas id="myCanvas" width="1444" height="600"></canvas>
        <button id="startGameButton">Start game</button>
    </div>

    <script>
        const canvas = document.getElementById("myCanvas");
        const ctx = canvas.getContext("2d");
        const velocity = 3;
        const jumpVelocity = 5;
        const gravity = 0.1;
        let rightPressed = false;
        let leftPressed = false;
        let loose = false;
        const playerWidth = 10;

        const platformList = [{
            x: canvas.offsetWidth / 2 - 150,
            y: 100,
            width: 300,
            height: 10
        }, {
            x: 150,
            y: 150,
            width: 300,
            height: 10
        }, {
            x: 200,
            y: 400,
            width: 300,
            height: 10
        }, {
            x: 250,
            y: 300,
            width: 300,
            height: 10
        }, {
            x: 300,
            y: 200,
            width: 300,
            height: 10
        }, {
            x: 350,
            y: 100,
            width: 300,
            height: 10
        }, {
            x: 400,
            y: canvas.offsetHeight / 2 + 200,
            width: 300,
            height: 10
        }];

        const player = new Player({ positionX: canvas.width / 2, positionY:0, size: 10, color: "#0095DD", ctx, jumpVelocity, velocity, gravity });
        
        function drawPlayer() {
            player.computeGravityVelocity();
            player.computePosition();
            player.draw();
        }

        function drawPlatform(x, y, width, height) {
            ctx.beginPath();
            ctx.rect(x, y, width, height);
            ctx.fillStyle = "#000000";
            ctx.fill();
            ctx.closePath();
        }

        function floatCalcul(number) {
            return Math.round(number * 1e2) / 1e2;
        }

        function displayLoose() {
            ctx.font = "30px Arial";
            ctx.fillText("You loose", canvas.width / 2 - 50, canvas.height / 2);
        }

        function draw() {
            collisionCheck();
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (loose) {
                displayLoose();
                return;
            }
            
            drawPlayer();
            platformList.forEach(platform => {
                drawPlatform(platform.x, platform.y, platform.width, platform.height);
            });
            
            if (rightPressed) {
                player.setDx(velocity);
            } else if (leftPressed) {
                player.setDx(-velocity);
            } else {
                if (player.dx > 0) {
                    player.setDx(Math.round((player.dx - 0.1) * 1e2) / 1e2);
                } else if (player.dx < 0) {
                    player.setDx(Math.round((player.dx + 0.1) * 1e2) / 1e2);
                } else {
                    player.setDx(0);
                }
            }
        }

        function collisionCheck() {
            if (player.y > canvas.offsetHeight - playerWidth) {
                loose = true;
            }

            const platform = platformList.find(platform => {
                if (player.x > platform.x && player.x < platform.x + platform.width && player.y >= platform.y - playerWidth && player.y < platform.y + 1 && player.dy >= 0) {
                    if (!player.onGround) {
                        
                        player.setY(platform.y - playerWidth);
                        player.setDy(0)
                        
                    }
                    player.setOnGround(true);
                    return true;
                }
            });

            if (!platform) {
                player.setOnGround(false);
            }
        }

        function keyDownHandler(e) {
            if (e.key === "Right" || e.key === "ArrowRight") {
                rightPressed = true;
            } else if (e.key === "Left" || e.key === "ArrowLeft") {
                leftPressed = true;
            } else if (e.key === "Up" || e.key === "ArrowUp") {
                player.jump();
            } else if (e.key === "Down" || e.key === "ArrowDown") {
                player.down();
            }
        }

        function keyUpHandler(e) {
            if (e.key === "Right" || e.key === "ArrowRight") {
                rightPressed = false;
            } else if (e.key === "Left" || e.key === "ArrowLeft") {
                leftPressed = false;
            }
        }


        document.getElementById("startGameButton").addEventListener("click", () => {
            setInterval(draw, 10);
        });
        document.addEventListener("keydown", keyDownHandler, false);
        document.addEventListener("keyup", keyUpHandler, false);

    </script>
  </body>
</html>
