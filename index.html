<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Gamedev Canvas Workshop</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      canvas {
        background: #eee;
        display: block;
        margin: 0 auto;
      }
    </style>
    <script src="./player.js"></script>
    <script src="./fireManager.js"></script>
  </head>
  <body>
    <div style="width: 480px; height: 320px;">
        <canvas id="myCanvas" width="1444" height="600"></canvas>
        <button id="startGameButton">Start game</button>
    </div>

    <script>
        const canvas = document.getElementById("myCanvas");
        const ctx = canvas.getContext("2d");
        const velocity = 3;
        const jumpVelocity = 5;
        const gravity = 0.15;
        const playerWidth = 20;
        const platformList = [{
            x: canvas.offsetWidth / 2 - 150,
            y: 100,
            width: 300,
            height: 10
        }, {
            x: 150,
            y: 150,
            width: 300,
            height: 10
        }, {
            x: 200,
            y: 400,
            width: 700,
            height: 10
        }, {
            x: 250,
            y: 300,
            width: 300,
            height: 10
        }, {
            x: 1000,
            y: 400,
            width: 300,
            height: 10
        }, {
            x: 300,
            y: 200,
            width: 600,
            height: 10
        }, {
            x: 400,
            y: canvas.offsetHeight / 2 + 200,
            width: 400,
            height: 10
        }];

        const fireManager = new FireManager({ ctx, canvas });

        const player = new Player({ name: 'Player Blue', positionX: canvas.width / 2, positionY:0, size: playerWidth, color: "#0095DD", ctx, jumpVelocity, velocity, gravity, canvas, fireManager });
        player.setPlatformList(platformList);
        const player2 = new Player({ name: 'Player Red', positionX: canvas.width / 4, positionY:0, size: playerWidth, color: "red", ctx, jumpVelocity, velocity, gravity, canvas, fireManager });
        player2.setPlatformList(platformList);
        player2.initControls({
            right: ["d"],
            left: ["q"],
            up: ["z"],
            down: ["s"],
            fire: ["c"]
        });

        const players = [player, player2];
        
        function drawPlayer() {
            players.forEach(player => player.draw());
        }

        function drawPlatform(x, y, width, height) {
            ctx.beginPath();
            ctx.rect(x, y, width, height);
            ctx.fillStyle = "#000000";
            ctx.fill();
            ctx.closePath();
        }

        function floatCalcul(number) {
            return Math.round(number * 1e2) / 1e2;
        }

        function displayLoose(player) {
            ctx.font = "30px Arial";
            ctx.fillText(`${player.name} loose`, canvas.width / 2 - 50, canvas.height / 2);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const loosingPlayer = players.find(player => player.loose)
            if (loosingPlayer) {
                displayLoose(loosingPlayer);
                return;
            }
            fireManager.draw()
            drawPlayer();
            platformList.forEach(platform => {
                drawPlatform(platform.x, platform.y, platform.width, platform.height);
            });
        }

        function keyDownHandler(e) {
            players.forEach(player => player.keyDownHandler(e));
        }

        function keyUpHandler(e) {
            players.forEach(player => player.keyUpHandler(e));
        }

        let gameId

        document.getElementById("startGameButton").addEventListener("click", () => {
            if (gameId) clearInterval(gameId);
            gameId = setInterval(draw, 10);
        });
        document.addEventListener("keydown", keyDownHandler, false);
        document.addEventListener("keyup", keyUpHandler, false);
    </script>
  </body>
</html>
